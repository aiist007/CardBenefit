# 信用卡权益管理系统 (CC-Benefit-App) 全应用说明书

这是一份关于“信用卡权益管理系统”的完整技术手册，涵盖了从前端架构、AI 解析到后端持久化存储的所有细节。

## 1. 系统架构概览 (Architecture Overview)

本应用基于 **Next.js 15 (App Router)** 构建，采用 **Full-stack React** 模式，核心逻辑分布在客户端 Context 和服务器端 API 路由中。

### 1.1 核心组件

- **前端 (Frontend)**: React 19, Tailwind CSS 4, Lucide Icons, Radix UI.
- **状态管理 (State Management)**: React Context API (`BenefitContext`).
- **后端 (API Layer)**: Next.js API Routes (Route Handlers).
- **AI 引擎 (AI Engine)**: Google Gemini (通过 OpenAI SDK 调用，集成 Nebula 代理)。
- **存储 (Storage)**: 文件系统直接持久化 (`data/benefits.toon`)，采用高效的 TOON 格式存储，集成 Git 自动提交备份。

---

## 2. 核心功能描述 (Core Features)

### 2.1 权益管理

- **列表与卡片视图**: 支持双视图切换，卡片视图采用动态配色（基于银行类型）。
- **智能搜索与筛选**: 支持银行、卡片名称、分类等多维度实时过滤。
- **CRUD 操作**: 支持权益的添加、编辑、删除、复制及“完成”状态标记。
- **自动合并 (Auto-Merge)**: 系统会自动识别相似标题的重复权益，并智能合并描述、价值等字段。

### 2.2 AI 智能解析 (The AI Core)

- **多模态抓取**:
  - **URL 解析**: 输入网页地址，系统自动抓取主页及关键子页（规则、详情）内容。
  - **图片识别**: 支持上传屏幕截图或宣传图。
- **TOON 协议优化**: 针对大批量数据传输，采用自定义的 **TOON (Token-Oriented Object Notation)** 格式，将 Token 消耗降低约 **42%**。
- **动态习得 (Dynamic Learning)**: AI 会在解析过程中总结新的行业规则（如：积分比例、特定银行隐藏规则），并自动追加到 `parsing_rules.md` 中。

### 2.3 异常恢复与备份

- **自动快照**: 每次数据写入前都会在 `data/backups/` 生成时间戳快照。
- **git 自动提交**: 保存数据时会自动执行 `git commit`，提供版本维度的保障。
- **系统紧急恢复**: 用户可通过 UI 选择历史快照版本进行一键回滚。

---

## 3. 技术实现细节 (Technical Implementation)

### 3.1 AI 解析流程 (API: `/api/parse`)

1. **输入处理**: 接收文本、URL 或图片。
2. **内容清洗**: HTML 剥离 CSS/Script，仅保留结构化文本。
3. **TOON 转换**: 在“修改模式”下，将现有数据转换为管道符分隔的 TOON 字符串。
4. **AI 提取**: 携带 `parsing_rules.md` 技能库，通过 Gemini 模型输出结构化 JSON。
5. **去重与标准化**: 银行/卡片名称自动规范化（见 `utils/bankUtils` 和 `utils/cardUtils`）。

### 3.2 数据层 (API: `/api/db`)

- **存储路径**: `data/benefits.toon` (旧版 `benefits.json` 已自动迁移)
- **初始化**: 首次运行自动检测并迁移旧数据，创建目录。
- **持久化策略**: 写入时自动转换为 TOON 格式及其高效存储；读取时自动解析为 JSON 供前端使用。

### 3.3 转换工具: TOON Format

```text
FIELDS: title|bank|cardName|category|...
DATA:
- 洁牙权益|招行|经典白|Health|...
```

*相比标准 JSON，它有效去除了双引号、大括号等高 Token 字符。*

---

## 4. 目录结构指南 (File Structure)

```bash
src/
├── app/
│   ├── api/
│   │   ├── chat/          # AI 聊天助手接口
│   │   ├── db/            # 数据库读写与备份接口
│   │   └── parse/         # 权益提取逻辑 (支持 TOON)
│   ├── globals.css        # 全局样式 (UI 主色调、微动画)
│   └── layout.tsx         # 根布局与 Context 注入
├── components/            # UI 组件库
│   ├── benefit/           # 权益专用组件 (Table, Card, Dialogs)
│   └── Dashboard.tsx      # 应用主控制面板
├── context/
│   └── BenefitContext.tsx # 全局状态引擎 (包含合并算法)
├── lib/                   # 核心解析逻辑
├── types/                 # TypeScript 定义与分类常量
└── utils/                 # 各类工具函数 (银行名称规范化等)
```

---

## 5. 项目部署与配置 (Deployment & Setup)

本项目已针对 GitHub 发布进行了安全优化。

### 5.1 快速上手 (Quick Start)

1. **克隆仓库**: `git clone ...`
2. **安装依赖**: `npm install`
3. **配置文件**:
   - 复制 `.env.example` 为 `.env`。
   - 在 `.env` 中填入你的 `GOOGLE_AI_STUDIO_API_KEY`。
   - 如果使用官方接口，请将 `OPENAI_BASE_URL` 设为 `https://api.openai.com/v1` 或留空。
4. **启动开发环境**: `npm run dev`

### 5.2 环境变量说明

| 变量名 | 描述 | 示例 |
| :--- | :--- | :--- |
| `GOOGLE_AI_STUDIO_API_KEY` | Gemini/OpenAI 的 API Key | `sk-xxxx...` |
| `OPENAI_BASE_URL` | AI 服务代理地址 (可选) | `https://llm.ai-nebula.com/v1` |

---

## 6. 开发与维护 (Maintenance)

- **更新解析规则**: 修改 `src/data/parsing_rules.md`。
- **手动修复数据**: 直接编辑根目录下的 `data/benefits.toon`（建议在系统关闭或停止写入时操作）。
- **运行环境**: 需配置 `GOOGLE_AI_STUDIO_API_KEY` 环境变量。

---
*Generated by Antigravity AI - Principal Software Architect*
