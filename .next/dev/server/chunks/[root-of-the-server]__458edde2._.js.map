{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/apple/Downloads/myapps/credit/src/app/api/parse/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport OpenAI from 'openai';\n\nconst COMMON_HEADERS = {\n    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\n    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',\n    'Accept-Language': 'zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7',\n    'Cache-Control': 'no-cache',\n    'Pragma': 'no-cache',\n    'Sec-Ch-Ua': '\"Not A(Bit:Brand\";v=\"99\", \"Google Chrome\";v=\"121\", \"Chromium\";v=\"121\"',\n    'Sec-Ch-Ua-Mobile': '?0',\n    'Sec-Ch-Ua-Platform': '\"macOS\"',\n    'Sec-Fetch-Dest': 'document',\n    'Sec-Fetch-Mode': 'navigate',\n    'Sec-Fetch-Site': 'none',\n    'Sec-Fetch-User': '?1',\n    'Upgrade-Insecure-Requests': '1',\n};\n\nfunction cleanHtml(html: string): string {\n    return html.replace(/<script\\b[^>]*>([\\s\\S]*?)<\\/script>/gim, \"\")\n        .replace(/<style\\b[^>]*>([\\s\\S]*?)<\\/style>/gim, \"\")\n        .replace(/<(?:p|div|li|tr|br|h[1-6]|section|span)\\b[^>]*>/gim, \"\\n\") // Preserve structure\n        .replace(/<[^>]+>/g, \" \")\n        .replace(/[ \\t]+/g, \" \") // Keep only one space, but allow newlines\n        .replace(/\\n\\s*\\n+/g, \"\\n\\n\") // Collapse multiple newlines\n        .trim();\n}\n\nasync function fetchPageContent(url: string, timeoutMs: number = 8000): Promise<{ text: string, images: string[] }> {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);\n\n    try {\n        const response = await fetch(url, {\n            headers: COMMON_HEADERS,\n            signal: controller.signal\n        });\n        if (!response.ok) {\n            if (response.status === 403) {\n                console.warn(`Sub-page fetch blocked (403): ${url}`);\n                return { text: '', images: [] };\n            }\n            return { text: '', images: [] };\n        }\n        const html = await response.text();\n\n        // Extract images - WeChat uses data-src for lazy loading\n        const imgRegex = /<img\\s+(?:[^>]*?\\s+)?(?:src|data-src)=\"([^\"]*)\"/gim;\n        const images = new Set<string>();\n        let imgMatch;\n        while ((imgMatch = imgRegex.exec(html)) !== null) {\n            const src = imgMatch[1];\n            try {\n                const imgUrl = new URL(src, url).href;\n                // Basic filter: skip icons, svg, data urls, trackers\n                if (!src.includes('data:') && !src.endsWith('.svg') && !src.includes('pixel') && !src.includes('tracker') && !src.includes('qrcode')) {\n                    images.add(imgUrl);\n                }\n            } catch (e) { }\n        }\n\n        return {\n            text: cleanHtml(html),\n            images: Array.from(images).slice(0, 5) // Limit to top 5 images per page\n        };\n    } catch (err) {\n        console.warn(`Fetch failed for sub-page ${url}:`, err);\n        return { text: '', images: [] };\n    } finally {\n        clearTimeout(timeoutId);\n    }\n}\n\nasync function imageUrlToBase64(url: string): Promise<string | null> {\n    try {\n        if (url.startsWith('data:')) {\n            return url;\n        }\n\n        const response = await fetch(url, { headers: COMMON_HEADERS });\n        if (!response.ok) return null;\n        const buffer = await response.arrayBuffer();\n        const mimeType = response.headers.get('content-type') || 'image/jpeg';\n        const base64 = Buffer.from(buffer).toString('base64');\n        return `data:${mimeType};base64,${base64}`;\n    } catch (e) {\n        console.warn(`Failed to convert image: ${url}`, e);\n        return null;\n    }\n}\n\nfunction tryRepairJson(json: string): string {\n    let repaired = json.trim();\n\n    // 1. Handle unclosed quotes (truncated strings)\n    let inString = false;\n    let escaped = false;\n    let quoteChar = '\"';\n\n    for (let i = 0; i < repaired.length; i++) {\n        const char = repaired[i];\n        if (char === '\\\\' && !escaped) {\n            escaped = true;\n            continue;\n        }\n        if (char === '\"' && !escaped) {\n            inString = !inString;\n        }\n        escaped = false;\n    }\n\n    if (inString) {\n        repaired += '\"';\n    }\n\n    // 2. Remove trailing comma if it's there after closing a quote or just at the end\n    repaired = repaired.trim();\n    if (repaired.endsWith(',')) {\n        repaired = repaired.slice(0, -1);\n    }\n\n    // 3. Balance braces and brackets\n    const stack: string[] = [];\n    // Re-scan to ensure we have the correct state after potentially adding a quote\n    inString = false;\n    escaped = false;\n\n    for (let i = 0; i < repaired.length; i++) {\n        const char = repaired[i];\n        if (char === '\\\\' && !escaped) {\n            escaped = true;\n            continue;\n        }\n        if (char === '\"' && !escaped) {\n            inString = !inString;\n        }\n        escaped = false;\n\n        if (!inString) {\n            if (char === '{') stack.push('}');\n            if (char === '[') stack.push(']');\n            if (char === '}' || char === ']') {\n                if (stack.length > 0 && stack[stack.length - 1] === char) {\n                    stack.pop();\n                }\n            }\n        }\n    }\n\n    // Add missing closers in reverse order\n    while (stack.length > 0) {\n        repaired += stack.pop();\n    }\n\n    return repaired;\n}\n\nexport async function POST(req: NextRequest) {\n    try {\n        const { text, url, screenshot, constraints, benefits, cardName: defaultCardName } = await req.json();\n        let contentToParse = text || '';\n        let imageUrls: string[] = [];\n\n        // Check if we are in \"Command Mode\" (modifying existing data)\n        const isCommandMode = !!(benefits && constraints && !url && !screenshot && !text);\n\n        if (isCommandMode) {\n            contentToParse = `[AI COMMAND MODE - MANIPULATING EXISTING DATA]\nUser Command: ${constraints}\n\nCurrent Benefits List:\n${JSON.stringify(benefits, null, 2)}`;\n        } else if (url) {\n            const controller = new AbortController();\n            const timeoutId = setTimeout(() => controller.abort(), 15000);\n\n            try {\n                const mainUrl = new URL(url);\n                const response = await fetch(url, {\n                    headers: COMMON_HEADERS,\n                    signal: controller.signal\n                });\n\n                if (!response.ok) {\n                    if (response.status === 403) {\n                        console.warn('Standard fetch blocked (403). Browser fallback is currently disabled.');\n                        throw new Error('Target website blocked access (403) and advanced browser parsing is disabled.');\n                    } else {\n                        throw new Error(`Server returned ${response.status} ${response.statusText}`);\n                    }\n                } else {\n                    const mainHtml = await response.text();\n                    const mainContent = cleanHtml(mainHtml);\n\n                    const isImageFile = (url: string) => /\\.(jpg|jpeg|png|webp|heic|heif)$/i.test(url.split('?')[0]);\n\n                    const imgRegex = /<img\\s+(?:[^>]*?\\s+)?(?:src|data-src)=\"([^\"]*)\"/gim;\n                    let imgMatch;\n                    while ((imgMatch = imgRegex.exec(mainHtml)) !== null) {\n                        try {\n                            const src = imgMatch[1];\n                            const imgUrl = new URL(src, url).href;\n                            if (!src.includes('data:') && isImageFile(imgUrl) && !src.includes('icon') && !src.includes('qrcode')) {\n                                imageUrls.push(imgUrl);\n                            }\n                        } catch (e) { }\n                    }\n\n                    const isWeChat = mainUrl.hostname === 'mp.weixin.qq.com';\n\n                    const linkRegex = /<a\\s+(?:[^>]*?\\s+)?href=\"([^\"]*)\"/gim;\n                    const links = new Set<string>();\n                    let match;\n                    while ((match = linkRegex.exec(mainHtml)) !== null) {\n                        const href = match[1];\n                        try {\n                            const absoluteUrl = new URL(href, url);\n                            const isSameDomain = absoluteUrl.hostname === mainUrl.hostname;\n                            const isRelevant = /detail|benefit|terms|rule|rights|权益|详情|规则|条款/i.test(href);\n\n                            // For WeChat, sub-pages are usually other articles, so we skip them to avoid context pollution\n                            if (isSameDomain && isRelevant && absoluteUrl.href !== mainUrl.href && !isWeChat) {\n                                links.add(absoluteUrl.href);\n                            }\n                        } catch (e) { }\n                    }\n\n                    const subPagesToFetch = Array.from(links).slice(0, 3);\n                    const subPagesData = await Promise.all(\n                        subPagesToFetch.map(link => fetchPageContent(link))\n                    );\n\n                    const validSubTexts = subPagesData.map(d => d.text).filter(t => t.length > 0);\n                    subPagesData.forEach(d => {\n                        imageUrls.push(...d.images);\n                    });\n\n                    contentToParse = `[Main Page Content]\\n${mainContent}\\n\\n` +\n                        validSubTexts.map((c, i) => `[Sub-page Content]\\n${c}`).join('\\n\\n');\n                }\n\n                imageUrls = Array.from(new Set(imageUrls)).slice(0, 10);\n                contentToParse = contentToParse.substring(0, 150000);\n            } catch (err: any) {\n                console.error('URL Fetch Error:', err);\n                if (!text) throw err;\n            } finally {\n                clearTimeout(timeoutId);\n            }\n        }\n\n        if (!contentToParse && !screenshot) {\n            return NextResponse.json({ error: 'No content to parse' }, { status: 400 });\n        }\n\n        if (!contentToParse && screenshot) {\n            contentToParse = \"[Visual content provided in screenshot]\";\n        }\n\n        const apiKey = process.env.GOOGLE_AI_STUDIO_API_KEY;\n\n        if (!apiKey) {\n            return NextResponse.json({ error: 'API Key (GOOGLE_AI_STUDIO_API_KEY) not configured.' }, { status: 500 });\n        }\n\n        // Initialize OpenAI client with nebula proxy\n        const openai = new OpenAI({\n            apiKey: apiKey,\n            baseURL: 'https://llm.ai-nebula.com/v1'\n        });\n\n        const systemPrompt = `你是一个专业的信用卡权益分析专家。\n你的任务是提取提供的文本或图片中${constraints ? `符合以下要求的` : `**所有的**`}信用卡权益信息。\n\n**核心规则：**\n1. ${constraints ? `优先遵循提取要求：${constraints}` : `穷举提取：必须抓取到最后。不要遗漏任何一个银行或平台的活动。`}\n2. 结构化输出：必须返回 JSON 格式，包含 \"benefits\" 数组。\n3. 字段要求（必须严格遵守以下字段名）：\n   - title: 权益名称。\n   - bank: 银行名称（如果是京东、支付宝等平台活动，银行填“京东”或“支付宝”）。\n   - cardName: 信用卡名称（如果未指定，填“全量信用卡”；严禁使用斜杠“/”）。\n   - category: 必须是 [Travel, Dining, Shopping, Insurance, Lifestyle, Vehicle, Health, Other] 之一。\n   - description: 权益详细内容描述。\n   - validity: 有效期/活动时间（如：2024-01-01至2024-03-31，或“每月一次”）。**必须仔细提取，不要遗漏。**\n   - value: 权益价值（如：50元立减金、10倍积分、免费洗车等）。**必须仔细提取。**\n   - usageCondition: 使用条件/达标条件（如：消费满1000元，或直接领取）。\n   - terms: 细则/名额限制（如：每日限1000名，每人限领一次）。\n\n**分类对应表：**\n- Travel: 出行、住宿、接送机、贵宾厅\n- Dining: 餐饮、美食、咖啡、外卖\n- Shopping: 购物、电商、超市、支付优惠\n- Insurance: 保险、延误险、意外险\n- Lifestyle: 生活服务、视听会员、运动、娱乐\n- Vehicle: 加油、洗车、停车、代驾\n- Health: 体检、挂号、洁牙\n- Other: 积分、还款、红包、其它\n\n**补充说明：**\n- 如果某个字段在原文中完全没有提及，请返回空字符串 \"\" 或 null，不要编造，但要尽可能从上下文推断（如从活动规则中推断出有效期）。\n- description 应该包含该权益的完整介绍，而 value 应该提炼出最核心的价值点。\n\n注意：内容可能较长，请确保${constraints ? `按要求精准提取` : `提取每一个被提到的活动`}。特别注意提取“有效期”、“价值”和“名额限制”等关键信息。`;\n\n        const userPrompt = constraints\n            ? `请根据以下材料，按提取要求“${constraints}”来提取信用卡权益。`\n            : `请从提供的材料中提取所有的信用卡权益。不要遗漏任何活动项。`;\n\n        let allExtractedBenefits: any[] = [];\n\n        if (isCommandMode) {\n            // --- AI COMMAND MODE: DIRECT DATA MANIPULATION ---\n            const commandSystemPrompt = `你是一个专业的信用卡数据管理助手。\n你的任务是根据用户的指令对提供的信用卡权益列表进行【外科手术式】的增、删、改操作。\n\n**核心规则：**\n1. 你必须返回一个包含三个列表的 JSON 对象：\n   - \"added\": [新权益对象1, ...] (如果是新增，包含生成的随机 UUID id)\n   - \"updated\": [包含原有ID且有修改的权益对象1, ...] (如果是修改)\n   - \"deleted\": [\"ID1\", \"ID2\", ...] (如果要删除)\n2. 保持数据格式（title, bank, cardName, category, description, validity, value, usageCondition, terms）。\n3. 准确执行指令：${constraints}\n\n**输出格式：**\n必须返回一个 JSON 对象，结构如下：\n{\n  \"added\": [],\n  \"updated\": [],\n  \"deleted\": []\n}`;\n\n            const response = await callAiWithContent(openai, commandSystemPrompt, contentToParse, []);\n\n            // Check if the response follows the changeset structure\n            let changeset = { added: [], updated: [], deleted: [] };\n            if (response && !Array.isArray(response) && (response.added || response.updated || response.deleted)) {\n                changeset = {\n                    added: Array.isArray(response.added) ? (response.added as any[]).map(b => ({ ...b, id: b.id || crypto.randomUUID() })) : [],\n                    updated: Array.isArray(response.updated) ? response.updated : [],\n                    deleted: Array.isArray(response.deleted) ? response.deleted : []\n                };\n            } else if (Array.isArray(response)) {\n                // Backward compatibility: if AI returned an array, treat it as 'added'\n                changeset.added = response.map(b => ({ ...b, id: b.id || crypto.randomUUID() }));\n            }\n\n            return NextResponse.json({\n                success: true,\n                isCommandMode: true,\n                changeset\n            });\n\n        } else {\n            // --- EXTRACTION MODE: PARSING NEW CONTENT ---\n            // 1. Process Text Content (Split if too long)\n            if (contentToParse && contentToParse.trim().length > 0) {\n                // Split content into chunks of ~12000 chars (expanded for better context)\n                const chunkSize = 12000;\n                const chunks = [];\n                for (let i = 0; i < contentToParse.length; i += chunkSize) {\n                    chunks.push(contentToParse.substring(i, i + chunkSize));\n                }\n\n                for (const chunk of chunks) {\n                    const response = await callAiWithContent(openai, systemPrompt, userPrompt + `\\n\\nContent Chunk:\\n${chunk}`, []);\n                    allExtractedBenefits = [...allExtractedBenefits, ...response];\n                }\n            }\n\n            // 2. Process Images (if any)\n            const allImageUrls = Array.from(new Set([...imageUrls, ...(screenshot ? [screenshot] : [])]));\n            if (allImageUrls.length > 0) {\n                for (const url of allImageUrls) {\n                    const base64 = await imageUrlToBase64(url);\n                    if (!base64) continue;\n\n                    const response = await callAiWithContent(openai, systemPrompt, userPrompt, [base64]);\n                    allExtractedBenefits = [...allExtractedBenefits, ...response];\n                }\n            }\n\n            // 3. Deduplicate only for EXTRACTION mode\n            const uniqueBenefits: any[] = [];\n            const seen = new Set();\n            allExtractedBenefits.forEach(b => {\n                const key = `${b.bank}-${b.title}`.toLowerCase().trim();\n                if (!seen.has(key)) {\n                    seen.add(key);\n                    uniqueBenefits.push(b);\n                }\n            });\n            allExtractedBenefits = uniqueBenefits;\n        }\n\n        return NextResponse.json({ benefits: allExtractedBenefits });\n    } catch (error: any) {\n        console.error('API Error:', error);\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n\nasync function callAiWithContent(openai: OpenAI, systemPrompt: string, userPrompt: string, imageBase64s: string[]): Promise<any[]> {\n    const messages: any[] = [\n        { role: \"system\", content: systemPrompt },\n        {\n            role: \"user\",\n            content: [\n                { type: \"text\", text: userPrompt + `\\n\\nReturn EXACTLY a JSON object with a \"benefits\" key containing the array.` }\n            ]\n        }\n    ];\n\n    imageBase64s.forEach(dataUrl => {\n        messages[1].content.push({\n            type: \"image_url\",\n            image_url: { url: dataUrl, detail: \"high\" }\n        });\n    });\n\n    let responseText = '';\n    for (let attempt = 1; attempt <= 2; attempt++) {\n        try {\n            const response = await openai.chat.completions.create({\n                model: \"gemini-3-flash-preview\",\n                messages: messages,\n                response_format: { type: \"json_object\" },\n                max_tokens: 8192,\n                temperature: 0.1,\n            });\n            responseText = response.choices[0].message.content || '';\n            if (responseText) break;\n        } catch (e) {\n            if (attempt === 2) throw e;\n        }\n    }\n\n    if (!responseText) return [];\n\n    try {\n        let jsonToParse = responseText;\n        if (jsonToParse.includes('```')) {\n            const match = jsonToParse.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/);\n            if (match) jsonToParse = match[1];\n        }\n\n        const firstBrace = jsonToParse.indexOf('{');\n        const lastBrace = jsonToParse.lastIndexOf('}');\n        let candidateJson = jsonToParse;\n        if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {\n            candidateJson = jsonToParse.substring(firstBrace, lastBrace + 1);\n        }\n\n        try {\n            const parsed = JSON.parse(candidateJson);\n            // If it's a changeset (has added/updated/deleted), return the whole object\n            if (!Array.isArray(parsed) && (parsed.added || parsed.updated || parsed.deleted)) {\n                return parsed;\n            }\n            // Otherwise follow existing logic\n            return Array.isArray(parsed) ? parsed : (parsed.benefits || []);\n        } catch (e) {\n            const startFromBrace = jsonToParse.indexOf('{');\n            if (startFromBrace !== -1) {\n                const repaired = tryRepairJson(jsonToParse.substring(startFromBrace));\n                const parsed = JSON.parse(repaired);\n                if (!Array.isArray(parsed) && (parsed.added || parsed.updated || parsed.deleted)) {\n                    return parsed;\n                }\n                return Array.isArray(parsed) ? parsed : (parsed.benefits || []);\n            }\n            throw e;\n        }\n    } catch (error) {\n        console.error('Failed to parse AI response part:', error);\n        return [];\n    }\n}\n"],"names":[],"mappings":"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"}}]
}