{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/apple/Downloads/myapps/credit/src/app/api/db/route.ts"],"sourcesContent":["import { promises as fs } from 'fs';\nimport path from 'path';\nimport { NextRequest, NextResponse } from 'next/server';\n\nconst DB_PATH = path.join(process.cwd(), 'data', 'benefits.json');\nconst BACKUPS_DIR = path.join(process.cwd(), 'data', 'backups');\n\n// Initialize DB and Folders if not exists\nasync function initDb() {\n    try {\n        await fs.mkdir(path.dirname(DB_PATH), { recursive: true });\n        await fs.access(DB_PATH);\n    } catch {\n        await fs.writeFile(DB_PATH, JSON.stringify([], null, 2));\n    }\n\n    try {\n        await fs.mkdir(BACKUPS_DIR, { recursive: true });\n    } catch (e) { }\n}\n\nasync function manageBackups() {\n    try {\n        const files = await fs.readdir(BACKUPS_DIR);\n        const backupFiles = files\n            .filter(f => f.startsWith('benefits_') && f.endsWith('.json'))\n            .map(f => ({ name: f, time: fs.stat(path.join(BACKUPS_DIR, f)).then(s => s.mtimeMs) }));\n\n        const resolvedFiles = await Promise.all(backupFiles.map(async f => ({ name: f.name, time: await f.time })));\n        resolvedFiles.sort((a, b) => b.time - a.time);\n\n        // Keep only top 5\n        if (resolvedFiles.length > 5) {\n            for (let i = 5; i < resolvedFiles.length; i++) {\n                await fs.unlink(path.join(BACKUPS_DIR, resolvedFiles[i].name));\n            }\n        }\n    } catch (e) {\n        console.error('Backup management failed:', e);\n    }\n}\n\nexport async function GET(req: NextRequest) {\n    try {\n        await initDb();\n        const { searchParams } = new URL(req.url);\n        const type = searchParams.get('type');\n\n        if (type === 'backups') {\n            const files = await fs.readdir(BACKUPS_DIR);\n            const backupFiles = files\n                .filter(f => f.startsWith('benefits_') && f.endsWith('.json'));\n\n            const details = await Promise.all(backupFiles.map(async f => {\n                const stats = await fs.stat(path.join(BACKUPS_DIR, f));\n                return { name: f, time: stats.mtimeMs, size: stats.size };\n            }));\n\n            details.sort((a, b) => b.time - a.time);\n            return NextResponse.json(details);\n        }\n\n        if (type === 'backup') {\n            const name = searchParams.get('name');\n            if (!name) return NextResponse.json({ error: 'Missing backup name' }, { status: 400 });\n\n            const backupPath = path.join(BACKUPS_DIR, name);\n            // Safety check: ensure the file is within the backups directory\n            if (!backupPath.startsWith(BACKUPS_DIR)) {\n                return NextResponse.json({ error: 'Invalid backup path' }, { status: 403 });\n            }\n\n            const data = await fs.readFile(backupPath, 'utf-8');\n            return NextResponse.json(JSON.parse(data));\n        }\n\n        const data = await fs.readFile(DB_PATH, 'utf-8');\n        return NextResponse.json(JSON.parse(data));\n    } catch (error) {\n        console.error('Database read error:', error);\n        return NextResponse.json({ error: 'Failed to read database' }, { status: 500 });\n    }\n}\n\nexport async function POST(req: NextRequest) {\n    try {\n        await initDb();\n        const benefits = await req.json();\n\n        // 1. Create a Snapshot before writing\n        try {\n            const currentContent = await fs.readFile(DB_PATH, 'utf-8');\n            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n            const backupPath = path.join(BACKUPS_DIR, `benefits_${timestamp}.json`);\n            await fs.writeFile(backupPath, currentContent);\n            await manageBackups();\n        } catch (e) {\n            console.warn('Backup creation failed, but proceeding with save:', e);\n        }\n\n        // 2. Write new data\n        await fs.writeFile(DB_PATH, JSON.stringify(benefits, null, 2));\n        return NextResponse.json({ success: true });\n    } catch (error) {\n        console.error('Database write error:', error);\n        return NextResponse.json({ error: 'Failed to write database' }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}